<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>EisenFlow | Master Orchestrator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #f8fafc;
            --accent: #2563eb;
            --bg: #ffffff;
            --border: #eef2f6;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --do: #ef4444;
            --plan: #3b82f6;
            --delegate: #f59e0b;
            --delete: #94a3b8;
            --note: #a855f7;
            --purple: #6f42c1;
        }

        html,
        body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: #fff;
        }

        .app-container {
            display: grid;
            grid-template-columns: 260px 420px 1fr;
            height: 100vh;
        }

        .app-container.full-view {
            grid-template-columns: 260px 1fr;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 40px 24px;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .logo {
            font-weight: 800;
            font-size: 22px;
            color: var(--text-main);
            letter-spacing: -1px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .nav-item {
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-sub);
            text-decoration: none;
            font-weight: 500;
            transition: 0.3s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item.active {
            background: #fff;
            color: var(--accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* --- PERSONA DESIGN --- */
        .persona-box {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            margin-top: auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.03);
        }

        .persona-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .persona-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: #f8fafc;
            color: var(--text-sub);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s ease;
            text-align: left;
        }

        .persona-btn:hover {
            background: #f1f5f9;
            color: var(--text-main);
            transform: translateX(4px);
        }

        .persona-btn.active {
            background: #fff;
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.08);
        }

        .dot-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #cbd5e1;
            transition: 0.3s;
        }

        .persona-btn.active .dot-indicator {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        /* --- FEED COLUMN --- */
        .feed-container {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            height: 100vh;
            min-width: 0;
            background: #fff;
        }

        .feed-header {
            padding: 32px 24px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .feed-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 20px 0;
            letter-spacing: -0.5px;
        }

        .feed-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #fbfcfd;
        }

        /* --- CARDS --- */
        .mail-card {
            background: #fff;
            padding: 20px 20px 20px 28px;
            border: 1px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            transition: 0.3s;
            flex-shrink: 0;
        }

        .mail-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
        }

        .mail-card.active {
            border-color: var(--accent);
            background: #f8faff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .status-strip {
            position: absolute;
            left: 0;
            top: 20px;
            bottom: 20px;
            width: 4px;
            border-radius: 0 4px 4px 0;
        }

        .dot-DO {
            background: var(--do);
        }

        .dot-PLAN {
            background: var(--plan);
        }

        .dot-DELEGATE {
            background: var(--delegate);
        }

        .dot-DELETE {
            background: var(--delete);
        }

        .dot-PENDING {
            background: #cbd5e1;
        }

        .importance-tag {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: inline-block;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .importance-tag:hover {
            transform: scale(1.05);
            filter: brightness(0.95);
        }

        .tag-DO {
            background: #fee2e2;
            color: var(--do);
            border: 2px solid #fca5a5;
        }

        .tag-PLAN {
            background: #dbeafe;
            color: var(--plan);
            border: 2px solid #93c5fd;
        }

        .tag-DELEGATE {
            background: #fef3c7;
            color: var(--delegate);
            border: 2px solid #f59e0b;
        }

        .tag-DELETE {
            background: #f1f5f9;
            color: var(--delete);
            border: 2px solid #cbd5e1;
        }

        .tag-PENDING {
            background: #f1f5f9;
            color: #64748b;
        }

        /* --- KANBAN & AGENDA VIEWS --- */
        .view-wrapper {
            padding: 60px;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
            background: #fff;
        }

        .kanban-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .kanban-col {
            flex: 1;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            min-height: 600px;
        }

        .kanban-col h3 {
            font-size: 13px;
            font-weight: 800;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-ai-status {
            background: var(--purple);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-ai-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        /* --- BUTTONS --- */
        .action-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #fff;
            border: 1px solid var(--border);
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-main);
        }

        .btn-primary {
            background: var(--text-main);
            color: #fff;
            border: none;
        }

        .btn-sync {
            color: #16a34a;
            border-color: #dcfce7;
        }

        /* --- CONTENT VIEW --- */
        .content-view {
            padding: 80px;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
            background: #fff;
        }

        .mail-title {
            font-size: 32px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        /* --- LOADER --- */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loader-bar {
            width: 160px;
            height: 3px;
            background: #f1f5f9;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .loader-bar::after {
            content: '';
            width: 60px;
            height: 3px;
            background: var(--accent);
            position: absolute;
            animation: load 1.4s infinite ease-in-out;
        }

        @keyframes load {
            from {
                left: -60px;
            }

            to {
                left: 160px;
            }
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="loader-bar"></div>
        <p id="loader-message"
            style="font-size: 11px; font-weight: 700; margin-top: 24px; letter-spacing: 3px; color: var(--text-main); text-transform: uppercase;">
            Mise √† jour...</p>
    </div>

    <div class="app-container" th:classappend="${view == 'events' or view == 'kanban' ? 'full-view' : ''}">
        <aside class="sidebar">
            <div class="logo">EisenFlow.</div>
            <div class="nav-group">
                <div class="nav-label">Workspace</div>
                <a href="/" th:class="${view == 'inbox' ? 'nav-item active' : 'nav-item'}"><i class="fas fa-inbox"></i>
                    Bo√Æte Mail</a>
                <a href="/knowledge" th:class="${view == 'knowledge' ? 'nav-item active' : 'nav-item'}"><i
                        class="fas fa-brain"></i> Knowledge Base</a>
                <a href="/events" id="link-agenda" th:class="${view == 'events' ? 'nav-item active' : 'nav-item'}"><i
                        class="fas fa-calendar-alt"></i> Agenda / RDV</a>
                <a href="/kanban" th:class="${view == 'kanban' ? 'nav-item active' : 'nav-item'}"><i
                        class="fas fa-columns"></i> Suivi Kanban</a>
            </div>

            <div class="persona-box">
                <div class="nav-label" style="margin:0">Active Profile</div>
                <form action="/persona" method="post" id="personaForm">
                    <input type="hidden" name="persona" id="selectedPersona">
                    <div class="persona-grid">
                        <button type="button" class="persona-btn"
                            th:classappend="${currentPersona.name() == 'ETUDIANT' ? 'active' : ''}"
                            onclick="switchPersona('ETUDIANT')">
                            <div class="dot-indicator"></div><span>üéì Student Mode</span>
                        </button>
                        <button type="button" class="persona-btn"
                            th:classappend="${currentPersona.name() == 'DEVELOPPEUR' ? 'active' : ''}"
                            onclick="switchPersona('DEVELOPPEUR')">
                            <div class="dot-indicator"></div><span>üíª Developer Mode</span>
                        </button>
                        <button type="button" class="persona-btn"
                            th:classappend="${currentPersona.name() == 'PROFESSEUR' ? 'active' : ''}"
                            onclick="switchPersona('PROFESSEUR')">
                            <div class="dot-indicator"></div><span>üë®‚Äçüè´ Teacher Mode</span>
                        </button>
                    </div>
                </form>
            </div>
        </aside>

        <main class="feed-container" th:if="${view != 'events' and view != 'kanban'}">
            <div class="feed-header">
                <h2 th:text="${view == 'inbox' ? 'Flux Gmail' : 'Vault Obsidian'}"></h2>

                <div class="action-bar">
                    <th:block th:if="${view == 'inbox'}">
                        <form action="/fetch" method="post" onsubmit="showLoader('Chargement des mails...');">
                            <button type="submit">Charger</button>
                        </form>

                        <form id="ai-form" action="/analyze" method="post"
                            onsubmit="showLoader('Analyse IA en cours (cela peut prendre du temps)...');">
                            <button id="btn-analyze" type="submit" class="btn-primary">Analyser IA</button>
                        </form>

                        <form action="/sync" method="post" onsubmit="showLoader('Synchronisation Gmail...');">
                            <button type="submit" class="btn-sync">Sync Gmail</button>
                        </form>
                    </th:block>
                </div>
            </div>

            <div class="feed-list">
                <th:block th:if="${view == 'inbox'}">
                    <div th:each="mail, iter : ${mails}" class="mail-card" th:data-id="${mail.messageId}"
                        th:data-index="${iter.index}"
                        onclick="openMail(this.getAttribute('data-id'), this.getAttribute('data-index'))"
                        th:id="'card-mail-' + ${iter.index}">
                        <div th:class="'status-strip dot-' + ${mail.action}"></div>
                        <div class="card-meta">
                            <span th:class="'importance-tag tag-' + ${mail.action}" th:text="${mail.action}"></span>
                            <span style="font-size: 11px; color: var(--text-sub);" th:text="${mail.date}"></span>
                        </div>
                        <div class="card-subject" th:text="${mail.subject}"></div>
                        <script th:inline="javascript">
                            window['mailData' + /*[[${iter.index}]]*/] = {
                                subject: /*[[${mail.subject}]]*/ '',
                                from: /*[[${mail.from}]]*/ '',
                                content: /*[[${mail.content}]]*/ ''
                            };
                        </script>
                    </div>
                </th:block>

                <th:block th:if="${view == 'knowledge'}">
                    <div th:each="note, iter : ${notes}" class="mail-card"
                        th:onclick="'openNote(' + ${iter.index} + ')'" th:id="'card-note-' + ${iter.index}">
                        <div th:class="'status-strip dot-' + ${note.action}"></div>
                        <div class="card-meta">
                            <span th:class="'importance-tag tag-' + ${note.action}" th:text="${note.action}"></span>
                            <span class="card-author" th:text="${note.author}"></span>
                        </div>
                        <div class="card-subject" th:text="${note.title}"></div>
                        <script th:inline="javascript">
                            window['noteData' + /*[[${iter.index}]]*/] = { title: /*[[${note.title}]]*/ '', author: /*[[${note.author}]]*/ '', content: /*[[${note.content}]]*/ '', action: /*[[${note.action}]]*/ '' };
                        </script>
                    </div>
                </th:block>
            </div>
        </main>

        <section th:class="${view == 'events' or view == 'kanban' ? 'view-wrapper' : 'content-view'}" id="main-reader">

            <th:block th:if="${view == 'events'}">
                <h1 style="font-size: 32px; font-weight:800; margin-bottom:30px;">Agenda IA</h1>

                <div th:if="${!#lists.isEmpty(events)}">
                    <div th:each="event : ${events}" class="mail-card" style="margin-bottom:15px; cursor:default;">
                        <div class="status-strip dot-DO"></div>
                        <div style="color:#2563eb; font-weight:700; margin-bottom:5px;" th:text="${event.dateLieu}">
                        </div>
                        <div th:text="${event.title}" style="font-weight:700; margin-bottom:10px;"></div>

                        <div style="display: flex; gap: 10px; align-items: center; margin-top:5px;">
                            <span class="importance-tag tag-DO">URGENT</span>

                            <button type="button"
                                style="padding: 6px 14px; border-radius: 6px; border: 1px solid #2563eb; background: #eff6ff; color: #2563eb; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;"
                                onmouseover="this.style.background='#2563eb'; this.style.color='#fff';"
                                onmouseout="this.style.background='#eff6ff'; this.style.color='#2563eb';"
                                th:data-id="${event.sourceId}"
                                onclick="generateMemo(this.getAttribute('data-id'), this)">
                                <i class="fas fa-magic"></i> G√©n√©rer M√©mo
                            </button>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(events)}"
                    style="text-align: center; padding: 50px; color: #6b7280; background: #f9fafb; border-radius: 12px; border: 1px dashed #e5e7eb;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìÖ</div>
                    <h3 style="margin-bottom: 5px; color: #374151;">Aucun rendez-vous</h3>
                    <p>Mettez un mail important en "DO" pour le voir appara√Ætre ici.</p>
                </div>
            </th:block>

            <th:block th:if="${view == 'kanban'}">
                <h1 style="font-size: 32px; font-weight:800; margin-bottom:10px;">Suivi D√©l√©gation</h1>
                <form action="/auto-status" method="post" onsubmit="showLoader('Analyse des statuts Kanban...');">
                    <button class="btn-ai-status"><i class="fas fa-robot"></i> Analyser Statuts IA</button>
                </form>
                <div class="kanban-container">
                    <div class="kanban-col">
                        <h3>üöÄ √Ä SUIVRE (DELEGATE)</h3>
                        <div th:each="mail : ${todoMails}" class="mail-card"
                            style="margin-bottom:15px; cursor:default;">
                            <div class="status-strip dot-DELEGATE"></div>
                            <div
                                style="font-size:11px; font-weight:700; color:#d97706; margin-bottom:5px; text-transform:uppercase; display:flex; align-items:center; gap:5px;">
                                <i class="fas fa-user-clock"></i>
                                <span th:text="${mail.status}">EN ATTENTE</span>
                            </div>
                            <strong th:text="${mail.subject}" style="display:block; margin-bottom:10px;"></strong>
                            <form action="/update-status" method="post">
                                <input type="hidden" name="messageId" th:value="${mail.messageId}">
                                <button type="submit" name="status" value="FINALIS√â"
                                    style="font-size:11px; padding:6px 12px; background:#dcfce7; color:#166534; border:1px solid #bbf7d0; border-radius:6px; width:100%; text-align:center;">
                                    ‚úÖ Valider & Terminer
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="kanban-col">
                        <h3>‚úÖ FINALIS√â</h3>
                        <div th:each="mail : ${doneMails}" class="mail-card"
                            style="margin-bottom:15px; cursor:default; opacity:0.6;">
                            <div class="status-strip dot-DO" style="background:#22c55e;"></div>
                            <strike th:text="${mail.subject}"></strike>
                            <form action="/update-status" method="post" style="margin-top:10px;">
                                <input type="hidden" name="messageId" th:value="${mail.messageId}">
                                <button type="submit" name="status" value="SUIVI"
                                    style="font-size:11px; padding:5px 10px; background:#f1f5f9; color:#64748b; border:none;">üîô
                                    R√©ouvrir</button>
                            </form>
                        </div>
                    </div>
                </div>
            </th:block>

            <div th:if="${view != 'events' and view != 'kanban'}"
                style="text-align: center; margin-top: 240px; color: #cbd5e1;">
                <div style="font-size: 64px; margin-bottom: 24px;">Workspace</div>
                <p style="font-size: 14px; font-weight: 500;">S√©lectionnez un √©l√©ment pour commencer</p>
            </div>
        </section>
    </div>

    <script>
        function showLoader(message) {
            if (message) document.getElementById('loader-message').innerText = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function switchPersona(role) {
            document.getElementById('selectedPersona').value = role;
            showLoader("Mode " + role + "...");
            document.getElementById('personaForm').submit();
        }

        function openMail(messageId, index) {
            document.querySelectorAll('.mail-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById('card-mail-' + index);
            if (card) card.classList.add('active');

            const data = window['mailData' + index];
            renderReader(data.subject, "Exp√©diteur : " + data.from, data.content, "#2563eb", null, messageId, false);
        }

        function renderReader(title, subtitle, content, accentColor, author, idOrIndex, isNote) {
            let avatar = author ? `<div style="width: 50px; height: 50px; background: #f3e8ff; color: #a855f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; margin-right:20px;">${author.charAt(0).toUpperCase()}</div>` : '';

            let actions = `
            <div style="margin-top: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="font-size: 11px; font-weight: 800; color: var(--text-sub); text-transform: uppercase;">Actions :</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="updatePriority('${idOrIndex}', 'DO', ${isNote})" class="importance-tag tag-DO">DO</button>
                        <button onclick="updatePriority('${idOrIndex}', 'PLAN', ${isNote})" class="importance-tag tag-PLAN">PLAN</button>
                        <button onclick="updatePriority('${idOrIndex}', 'AUTO DELEGATE', ${isNote})" class="importance-tag tag-DELEGATE">AUTO DELEGATE</button>
                        <button onclick="updatePriority('${idOrIndex}', 'DELETE', ${isNote})" class="importance-tag tag-DELETE">DELETE</button>
                    </div>
                </div>
                
                <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                    <span style="font-size: 11px; font-weight: 800; color: var(--text-sub); display:block; margin-bottom:12px;">OU ASSIGNER MANUELLEMENT :</span>
                    <form action="/delegate-manual" method="post" style="display: flex; gap: 10px;">
                        <input type="hidden" name="messageId" value="${idOrIndex}">
                        <select name="assignee" style="flex:1; padding:10px; border-radius:8px; border:1px solid #cbd5e1; background: white; font-family:'Inter'; font-size:13px;">
                            <option value="Thomas">Thomas (Expert Backend)</option>
                            <option value="Sophie">Sophie (Expert Frontend)</option>
                            <option value="Marc">Marc (Expert Ops)</option>
                            <option value="Julie">Julie (Manager)</option>
                        </select>
                        <button type="submit" style="background:#f59e0b; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">D√©l√©guer</button>
                    </form>
                </div>

                <div id="delegation-result-${idOrIndex}" style="display:none; border-top:1px solid #e2e8f0; margin-top:15px; padding-top:15px;">
                    <div style="font-size:10px; color:#64748b; font-weight:700; margin-bottom:5px;">ü§ñ SUGGESTION IA POUR <span id="del-who-${idOrIndex}">...</span></div>
                    <textarea id="del-draft-${idOrIndex}" style="width:100%; height:120px; padding:12px; border:1px solid #cbd5e1; border-radius:8px; font-family:'Inter'; font-size:13px; color:#334155; line-height:1.5; resize:none; box-sizing:border-box;"></textarea>
                    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:11px; color:#94a3b8; font-family:monospace; background:#f1f5f9; padding:4px 8px; border-radius:4px;">ID: <span id="del-id-${idOrIndex}">...</span></span>
                        <button onclick="alert('Brouillon enregistr√© !')" style="background:#2563eb; color:white; border:none; padding:8px 16px; border-radius:8px; font-size:12px; font-weight:600;">Sauvegarder</button>
                    </div>
                </div>
            </div>`;

            document.getElementById('main-reader').innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 24px;">
                ${avatar}
                <div>
                    <h1 class="mail-title">${title}</h1>
                    <div style="font-size: 15px; color: var(--text-sub);">${subtitle}</div>
                </div>
            </div>
            ${actions}
            <div style="margin-top: 32px; font-size: 16px; line-height: 1.8; color: #334155; white-space: pre-wrap;">${content}</div>`;
        }

        function startDelegation(messageId) {
            const resultDiv = document.getElementById('delegation-result-' + messageId);
            resultDiv.style.display = 'block';
            document.getElementById('del-who-' + messageId).innerText = "Analyse...";

            fetch('/delegate-auto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'messageId=' + encodeURIComponent(messageId)
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('del-who-' + messageId).innerText = data.assignee;
                    document.getElementById('del-draft-' + messageId).value = data.draftBody;
                    document.getElementById('del-id-' + messageId).innerText = data.trackingId;
                });
        }

        function updatePriority(idOrIndex, newTag, isNote) {
            showLoader("Mise √† jour...");
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = isNote ? '/update-note-tag' : '/update-mail-tag';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = isNote ? 'index' : 'messageId';
            idInput.value = idOrIndex;

            const tagInput = document.createElement('input');
            tagInput.type = 'hidden'; tagInput.name = 'tag'; tagInput.value = newTag;

            form.appendChild(idInput);
            form.appendChild(tagInput);
            document.body.appendChild(form);
            form.submit();
        }

        function hideLoader() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function generateMemo(messageId, btnElement) {
            // 1. On affiche l'√©cran de chargement
            showLoader("L'IA g√©n√®re la fiche m√©mo en PDF...");

            const formData = new FormData();
            formData.append("messageId", messageId);

            // 2. On appelle le serveur avec fetch classique
            fetch('/events/prepare', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Erreur lors de la g√©n√©ration");
                    }
                    // 3. On extrait le fichier PDF de la r√©ponse
                    return response.blob();
                })
                .then(blob => {
                    // 4. On cr√©e le nouveau bouton "T√©l√©charger PDF" une fois le fichier re√ßu
                    const url = window.URL.createObjectURL(blob);
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = url;
                    downloadBtn.download = 'Fiche_Memo_' + messageId + '.pdf';
                    downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> T√©l√©charger PDF';

                    // Le style CSS du bouton PDF (Rouge)
                    downloadBtn.style.cssText = "padding: 6px 14px; border-radius: 6px; border: 1px solid #ef4444; background: #fee2e2; color: #ef4444; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: all 0.2s;";

                    downloadBtn.onmouseover = function () { this.style.background = '#ef4444'; this.style.color = '#fff'; };
                    downloadBtn.onmouseout = function () { this.style.background = '#fee2e2'; this.style.color = '#ef4444'; };

                    // 5. On remplace l'ancien bouton bleu par le nouveau bouton rouge !
                    btnElement.parentNode.replaceChild(downloadBtn, btnElement);
                })
                .catch(error => {
                    // En cas de probl√®me
                    console.error("Erreur:", error);
                    alert("‚ùå Une erreur est survenue lors de la g√©n√©ration de la fiche PDF.");
                })
                .finally(() => {
                    // 6. Quoi qu'il arrive, on cache l'√©cran de chargement √† la fin
                    hideLoader();
                });
        }
    </script>
</body>

</html>